schema: 1

bugzilla:
  product: Core
  component: "Graphics: WebGPU"

origin:
  name: WebGPU CTS
  description: WebGPU Compliance Test Suite
  url: https://gpuweb.github.io/cts/
  release: 0558b1933531e6379ac5875129b92aac9d1ce035 (2025-08-26T18:27:38Z).
  revision: 0558b1933531e6379ac5875129b92aac9d1ce035
  license: ['BSD-3-Clause']

updatebot:
    maintainer-phab: '#webgpu-reviewers!'
    maintainer-bz: egubler@mozilla.com
    try-preset: webgpu
    tasks:
      - type: vendoring
        enabled: true
        frequency: 1 week
        blocking: 1863146  # webgpu-update-cts

vendoring:
  url: https://github.com/gpuweb/cts
  source-hosting: github
  vendor-directory: dom/webgpu/tests/cts/checkout/
  skip-vendoring-steps:
    - update-moz-build
  include:
    - .gitattributes
    - .gitignore  # Avoids re-formatting of generated files.
  update-actions:
    # Use the version from `mach vendor`, instead of a script that consults Git. This is wrong,
    # because (1) it would use a Git checkout of _Gecko_ rather than CTS, and (2) we might not even
    # have a Git checkout if we're using Mercurial.
    - action: replace-in-file
      file: '{yaml_dir}/checkout/tools/gen_version'
      pattern: "const { version } = require('../src/common/tools/version.ts');"
      with: "const version = '{revision}';"

    # Patch the `baseResourcePath` used by the CTS so that the tests we
    # generate are able to load resources correctly.
    # This must be invoked as a run-command prior to the `cargo run` step
    # below, as it patches the original typescript sources. If we used
    # moz.yaml's `patches` mechanism it would apply the patch to the typescript
    # sources after we have already processed them and written our tests to
    # their final location.
    - action: run-command
      cwd: '{yaml_dir}/checkout/'
      command: patch
      args:
        - -p1
        - -i
        - ../patches/0001-base-resource-path.patch

    - action: run-command
      cwd: '{yaml_dir}/vendor/'
      command: cargo
      args:
        - run
        - --no-default-features
        - --
        - '../checkout/'

    - action: delete-path
      path: '../../../../../testing/web-platform/mozilla/tests/webgpu/'
    - action: move-dir
      from: '{yaml_dir}/checkout/out-wpt/'
      to: '../../../../../testing/web-platform/mozilla/tests/webgpu/'

    - action: delete-path
      path: '{yaml_dir}/checkout/node_modules/'
    - action: delete-path
      path: '{yaml_dir}/checkout/gen/'
    - action: delete-path
      path: '{yaml_dir}/checkout/out/'
    - action: delete-path
      path: '{yaml_dir}/checkout/deploy_key.enc'
    - action: vcs-add-remove-files
      path: '../../../../../testing/web-platform/mozilla/tests/webgpu/'
